<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show Ratings</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="./assets/js/api.js"></script>
    <script src="./assets/js/search.js"></script>
    <style>
        /* General styling */
      body {
          margin: 0;
          background-color: #111111;
          color: white;
      }

      .header{
        position: relative;
      }

      .container-ra {
          display: flex;
          gap: 32px;
          max-width: 1200px;
          margin: 55px auto;
          padding-left: 140px;
      }

      .show-info {
          flex: 0 0 200px;
      }

      .poster {
          width: 200px;
          border-radius: 8px;
          margin-bottom: 16px;
      }

      .show-title {
          font-size: 24px;
          margin: 0 0 8px 0;
          font-weight: bold;
      }

      .rating {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
      }

      .star {
          color: orange;
          font-size: 18px;
      }
      
      #votes{
          display: inline-block;
      }

      .rating-value {
          font-size: 16px;
          font-weight: bold;
      }

      .votes {
          color: #a1a1aa;
          font-size: 13px;
      }

      .years {
          color: #a1a1aa;
          margin-bottom: 16px;
          font-size: 12px;
      }

      .legend {
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
          margin-bottom: 15px;
      }

      .legend-item {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 0.9rem;
      }

      .legend-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
      }

      .ratings-grid {
          flex: 1;
      }

      .season-headers {
          display: grid;
          grid-template-columns: 57px repeat(auto-fill, 40px);
          gap: 14px;
          margin-bottom: 4px;
          color: #a1a1aa;
          font-size: 0.9rem;
      }

      .episodes-container {
          display: grid;
          gap: 6px;
      }

      .episode-row {
          display: grid;
          grid-template-columns: 40px repeat(auto-fill, 40px);
          gap: 14px; /* Add spacing between episodes */
      }

      .episode-number {
          display: flex;
          align-items: center;
          font-size: 0.9rem;
          color: #a1a1aa;
      }

      .episode {
          width: 48px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 4px;
          font-weight: 500;
          cursor: pointer;
          position: relative;
          transition: transform 0.2s;
          font-size: 16px;
          gap: 4px;
      }

      .episode:hover {
          transform: scale(1.1);
          z-index: 2;
      }

      .tooltip {
          position: absolute;
          left: 50%;
          bottom: calc(100% + 8px);
          transform: translateX(-50%);
          background-color: rgba(0, 0, 0, 0.95);
          padding: 8px;
          border-radius: 4px;
          font-size: 13px;
          white-space: nowrap;
          visibility: hidden;
          opacity: 0;
          transition: opacity 0.15s;
          z-index: 3;
          width: max-content;
          text-align: center;
      }

      .tooltip::after {
          content: '';
          position: absolute;
          bottom: -4px;
          left: 50%;
          transform: translateX(-50%);
          border-left: 4px solid transparent;
          border-right: 4px solid transparent;
          border-top: 4px solid rgba(0, 0, 0, 0.95);
      }

      .episode:hover .tooltip {
          visibility: visible;
          opacity: 1;
      }

      .episode-title {
          display: block;
          margin-bottom: 4px;
          font-weight: normal;
          color: white;
      }

      .episode-info {
          display: block;
          font-size: 11px;
          color: #999;
      }

      /* Rating colors */
      .awesome { background-color: #186a3b; }
      .great { background-color: #28b463; }
      .good { background-color: #f4d03f; color: black; }
      .regular { background-color: #fb923c; color: black; }
      .bad { background-color: #e74c3c; }
      .garbage { background-color: #633974; }

      .legend-awesome { background-color: #186a3b; }
      .legend-great { background-color: #28b463; }
      .legend-good { background-color: #f4d03f; }
      .legend-regular { background-color: #fb923c; }
      .legend-bad { background-color: #e74c3c; }
      .legend-garbage { background-color: #633974; }

      .unknown {
          background-color: #bdbdbd;
          color: black;
      }

      .ratings-grid {
            flex: 1;
            overflow: hidden; /* Hide overflow on the main container */
        }

        .scroll-container {
            position: relative;
            margin-bottom: 16px;
        }

        .scroll-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding-bottom: 12px; /* Add padding for scroll bar */
            /* Improve smooth scrolling */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Hide scrollbar but keep functionality */
        .scroll-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .scroll-wrapper::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }

        .scroll-wrapper::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        .scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        .season-headers {
            display: flex; /* Change from grid to flex */
            gap: 6px;
            margin-bottom: 4px;
            color: #a1a1aa;
            font-size: 0.9rem;
            min-width: max-content; /* Prevent wrapping */
        }

        .season-headers > div {
            width: 40px; /* Fixed width for season headers */
            text-align: center;
        }

        .season-headers > div:first-child {
            width: 57px; /* Width for episode number column */
        }

        .episodes-container {
            display: block; /* Change from grid to block */
        }

        .episode-row {
            display: flex; /* Change from grid to flex */
            gap: 6px;
            margin-bottom: 6px;
            min-width: max-content; /* Prevent wrapping */
        }

        .episode-number {
            width: 57px; /* Fixed width for episode numbers */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .episode {
            width: 40px; /* Fixed width for episodes */
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Target the first two episode rows */
#episodes .episode-row:nth-child(-n+2) .episode .tooltip {
    bottom: auto; /* Remove original bottom positioning */
    /* Use the user's specific calculation if needed */
    bottom: calc(-239% + 8px);
}

/* Create the downward-pointing arrow with ::before */
#episodes .episode-row:nth-child(-n+2) .episode .tooltip::before {
    content: '';
    position: absolute;
    bottom: 56px; /* Adjust based on your layout */
    left: 50%;
    transform: translateX(-50%);
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 4px solid rgba(0, 0, 0, 0.95);
}

/* Hide the original ::after arrow for these tooltips */
#episodes .episode-row:nth-child(-n+2) .episode .tooltip::after {
    display: none;
}
          /* Rating bar styling */
      .show-rating {
          margin-top: 15px;
          margin-bottom: 20px;
      }
      
      .rating-bar {
          height: 6px;
          background-color: rgba(255, 255, 255, 0.1);
          border-radius: 3px;
          overflow: hidden;
          margin-bottom: 5px;
      }
      
      .rating-fill {
          height: 100%;
          background-color: #e50914;
          border-radius: 3px;
      }
      
      .rating-text {
          font-size: 0.9rem;
          color: #a1a1aa;
      }
    </style>
<script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
</head>
<body>

  <header class="header" data-header>
    <div class="container">

      <div class="overlay" data-overlay></div>

      <a href="./index.html" class="logo">
        <img src="./assets/images/heading_purple.png" class="sparkscreen">
      </a>

      <div class="header-actions">
        <div class="search-btn-container">
          <button class="search-btn" onclick="toggleSearchInput()">
            <ion-icon name="search-outline"></ion-icon>
          </button>
        </div>
      </div>
      
      <button class="menu-open-btn" data-menu-open-btn>
        <ion-icon name="reorder-two"></ion-icon>
      </button>

      <nav class="navbar" data-navbar>

        <div class="navbar-top">

          <a href="./index.html" class="logo">
            <img src="./assets/images/logo.svg" alt="FilFuse logo">
          </a>

          <button class="menu-close-btn" data-menu-close-btn>
            <ion-icon name="close-outline"></ion-icon>
          </button>

        </div>

        <ul class="navbar-list">

          <li>
            <a href="./index.html" class="navbar-link">Home</a>
          </li>

          <li>
            <a href="./discover.html" class="navbar-link">Discover</a>
            <ul>
              <li>
                <a href="./top-100.html" class="navbar-link">Top 100</a>
              </li>
              <li>
                <a href="./best-movies-2024.html" class="navbar-link">Best Movies of 2024</a>
              </li>
            </ul>

          </li>

          <li>
            <a href="./suggestions.html" class="navbar-link">Suggestions</a>
            <ul>
              <li>
                <a href="./date-night.html" class="navbar-link">Date Night</a>
              </li>
            </ul>
          </li>

          <li>
            <a href="./ai-finder.html" class="navbar-link">Find lost movies</a>
          </li>

          <li>
            <a href="./about.html" class="navbar-link">About</a>
          </li>

        </ul>

        <ul class="navbar-social-list">

          <li>
            <a href="#" class="navbar-social-link">
              <ion-icon name="logo-instagram"></ion-icon>
            </a>
          </li>

          <li>
            <a href="#" class="navbar-social-link">
              <ion-icon name="logo-github"></ion-icon>
            </a>
          </li>

        </ul>

      </nav>
    </div>
</header>

  <div class="search-el">
    <div class="input-main-div">
    <input name="query" type="text" tabindex="1" autocorrect="off" autofill="off" autocomplete="off" spellcheck="false" id="search-input" placeholder="Search for a movie, tv show, person..." class="input-main">
    </div>
    <div id="default-results" class="results-container"></div>
  </div>
  <div class="container-ra">
      <div class="show-info">
        <img id="poster" src="https://placehold.co/300x450" alt="Show poster" class="poster">
          <div class="rating">
              <span class="star">★</span>
              <span id="rating" class="rating-value">0.0</span>
              <span class="votes">(<span id="votes">0</span> votes)</span>
          </div>
          <h1 id="title" class="show-title">Show Title</h1>
          <div id="years" class="years">0000 - 0000</div>
      </div>

      <div class="ratings-grid">
        <div class="legend">
          <div class="legend-item">
              <div class="legend-dot legend-awesome"></div>
              <span>Awesome</span>
          </div>
          <div class="legend-item">
              <div class="legend-dot legend-great"></div>
              <span>Great</span>
          </div>
          <div class="legend-item">
              <div class="legend-dot legend-good"></div>
              <span>Good</span>
          </div>
          <div class="legend-item">
              <div class="legend-dot legend-regular"></div>
              <span>Regular</span>
          </div>
          <div class="legend-item">
              <div class="legend-dot legend-bad"></div>
              <span>Bad</span>
          </div>
          <div class="legend-item">
              <div class="legend-dot legend-garbage"></div>
              <span>Don't</span>
          </div>
      </div>
        <div class="scroll-container">
          <div class="scroll-wrapper">
              <div id="season-headers" class="season-headers"></div>
              <div id="episodes" class="episodes-container"></div>
          </div>
        </div>
      </div>
  </div>


  <script>
const API_KEY = "054582e9ee66adcbe911e0008aa482a8";

// Function to get the show ID from the URL
const getShowIdFromUrl = () => {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
};

const fetchShowDetails = async (showId) => {
    const response = await fetch(`https://api.themoviedb.org/3/tv/${showId}?api_key=${API_KEY}&language=en-US`);
    const data = await response.json();
    displayShowDetails(data);
    fetchSeasonDetails(data.id, data.number_of_seasons);
};

const displayShowDetails = (data) => {
    document.getElementById("poster").src = `https://image.tmdb.org/t/p/w500${data.poster_path}`;
    document.getElementById("title").textContent = data.name;

    const ratingElement = document.getElementById("rating");
    if (data.vote_average === 0.0) {
        ratingElement.textContent = "?";
        ratingElement.style.color = "#bdbdbd";
    } else {
        ratingElement.textContent = data.vote_average.toFixed(1);
    }

    document.getElementById("votes").textContent = data.vote_count.toLocaleString();
    document.getElementById("years").textContent = `${data.first_air_date.split("-")[0]} - ${data.last_air_date ? data.last_air_date.split("-")[0] : "Present"}`;
};

const fetchSeasonDetails = async (showId, seasons) => {
    const container = document.getElementById("episodes");
    const episodesByNumber = {};
    
    // Generate season headers
    const seasonHeaders = document.getElementById("season-headers");
    seasonHeaders.innerHTML = '<div></div>'; // Empty cell for episode numbers
    for (let i = 1; i <= seasons; i++) {
        const seasonHeader = document.createElement("div");
        seasonHeader.textContent = `S${i}`;
        seasonHeaders.appendChild(seasonHeader);
    }

    // Fetch all seasons
    for (let i = 1; i <= seasons; i++) {
        const response = await fetch(`https://api.themoviedb.org/3/tv/${showId}/season/${i}?api_key=${API_KEY}&language=en-US`);
        const seasonData = await response.json();
        
        // Group episodes by episode number
        seasonData.episodes.forEach(episode => {
            if (!episodesByNumber[episode.episode_number]) {
                episodesByNumber[episode.episode_number] = [];
            }
            episodesByNumber[episode.episode_number][seasonData.season_number - 1] = episode;
        });
    }

    // Create episode rows
    Object.keys(episodesByNumber)
        .sort((a, b) => Number(a) - Number(b))
        .forEach(episodeNumber => {
            const row = document.createElement("div");
            row.className = "episode-row";
            
            // Add episode number
            const episodeNumberDiv = document.createElement("div");
            episodeNumberDiv.className = "episode-number";
            episodeNumberDiv.textContent = `E${episodeNumber}`;
            row.appendChild(episodeNumberDiv);
            
            // Add episode ratings
            for (let i = 0; i < seasons; i++) {
                const episode = episodesByNumber[episodeNumber][i];
                const episodeDiv = document.createElement("div");
                
                if (!episode) {
                    episodeDiv.className = "episode empty";
                    episodeDiv.textContent = "";
                } else if (episode.vote_average === 0.0) {
                    episodeDiv.className = "episode unknown";
                    episodeDiv.textContent = "?";
                    
                    // Add click handler for episodes without ratings
                    episodeDiv.addEventListener('click', () => {
                        showEpisodeDetails(episode, showId, i + 1, episode.episode_number);
                    });
                    
                    const tooltip = document.createElement("div");
                    tooltip.className = "tooltip";
                    tooltip.innerHTML = `
                        <span class="episode-title">${episode.name}</span>
                        <span class="episode-info">Season ${episode.season_number}, Episode ${episode.episode_number}</span>
                        <span class="episode-info">Click for details</span>
                    `;
                    episodeDiv.appendChild(tooltip);
                } else {
                    episodeDiv.className = `episode ${getRatingClass(episode.vote_average)}`;
                    episodeDiv.textContent = episode.vote_average.toFixed(1);
                    
                    // Add click handler for rated episodes
                    episodeDiv.addEventListener('click', () => {
                        showEpisodeDetails(episode, showId, i + 1, episode.episode_number);
                    });
                    
                    const tooltip = document.createElement("div");
                    tooltip.className = "tooltip";
                    tooltip.innerHTML = `
                        <span class="episode-title">${episode.name}</span>
                        <span class="episode-info">Season ${episode.season_number}, Episode ${episode.episode_number}</span>
                        <span class="episode-info">Click for details</span>
                    `;
                    episodeDiv.appendChild(tooltip);
                }
                
                row.appendChild(episodeDiv);
            }
            
            container.appendChild(row);
        });
};

const getRatingClass = (rating) => {
    if (rating >= 9) return "awesome";
    if (rating >= 8) return "great";
    if (rating >= 7) return "good";
    if (rating >= 5) return "regular";
    if (rating >= 3) return "bad";
    return "garbage";
};

// Get the show ID from the URL and fetch the show details
const showId = getShowIdFromUrl();
if (showId) {
    fetchShowDetails(showId);
} else {
    console.error("No show ID found in the URL.");
}
</script>
<script src="./assets/js/script.js"></script>

    <!-- Episode Details Popup -->
    <div id="episodePopup" class="episode-popup">
        <div class="popup-overlay"></div>
        <div class="popup-content">
            <button class="close-popup" onclick="closeEpisodePopup()">
                <ion-icon name="close"></ion-icon>
            </button>
            <div class="popup-header">
                <h2 id="popupEpisodeTitle">Loading...</h2>
            </div>
            <div class="popup-body">
                <div class="media-container">
                    <div id="episodeTrailer" class="episode-trailer"></div>
                </div>
                <div class="episode-meta">
                    <div class="episode-meta-content">
                        <div class="meta-row">
                            <span id="episodeAirdate" class="airdate"></span>
                            <span id="episodeRating" class="rating"></span>
                            <span id="episodeVoteCount" class="vote-count"></span>
                        </div>
                        <p id="episodeOverview" class="overview"></p>
                        <div class="screenshots" id="episodeScreenshots">
                            <div class="loading">Loading screenshots...</div>
                        </div>
                    </div>
                    <div class="download-buttons">
                        <a id="downloadEpisodeBtn" href="#" class="download-btn episode-download">
                            <ion-icon name="download-outline"></ion-icon>
                            <span>Download<br>This Episode</span>
                        </a>
                        <a id="downloadSeasonBtn" href="#" class="download-btn season-download">
                            <ion-icon name="albums-outline"></ion-icon>
                            <span>Download<br>This Season</span>
                        </a>
                        <a id="downloadAllSeasonsBtn" href="#" class="download-btn all-seasons-download">
                            <ion-icon name="folder-outline"></ion-icon>
                            <span>Download<br>All Seasons</span>
                        </a>
                    </div>
                </div>
            </div>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Function to show episode details popup
        function showEpisodeDetails(episodeData, showId, seasonNumber, episodeNumber) {
            const popup = document.getElementById('episodePopup');
            const popupContent = popup.querySelector('.popup-content');
            const popupOverlay = popup.querySelector('.popup-overlay');
            const title = document.getElementById('popupEpisodeTitle');
            const trailerContainer = document.getElementById('episodeTrailer');
            const airdate = document.getElementById('episodeAirdate');
            const rating = document.getElementById('episodeRating');
            const voteCount = document.getElementById('episodeVoteCount');
            const overview = document.getElementById('episodeOverview');
            const screenshots = document.getElementById('episodeScreenshots');
            const downloadEpisodeBtn = document.getElementById('downloadEpisodeBtn');
            const downloadSeasonBtn = document.getElementById('downloadSeasonBtn');
            
            // Show loading state
            popup.style.display = 'block';
            void popup.offsetHeight; // Trigger reflow
            popup.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Clear previous content
            trailerContainer.innerHTML = '<div class="loading">Loading trailer...</div>';
            screenshots.innerHTML = '<div class="loading">Loading screenshots...</div>';
            
            // Set episode info
            title.textContent = `S${String(seasonNumber).padStart(2, '0')}E${String(episodeNumber).padStart(2, '0')} - ${episodeData.name || 'Episode ' + episodeNumber}`;
            airdate.textContent = episodeData.air_date ? new Date(episodeData.air_date).toLocaleDateString() : 'TBA';
            rating.textContent = episodeData.vote_average ? `⭐ ${episodeData.vote_average.toFixed(1)}` : 'N/A';
            voteCount.textContent = episodeData.vote_count ? `(${episodeData.vote_count} votes)` : '';
            overview.textContent = episodeData.overview || 'No overview available.';
            
            // Set download links with proper parameters
            const showIdParam = `show=${showId}`;
            const seasonParam = `&season=${seasonNumber}`;
            const episodeParam = `&episode=${episodeNumber}`;
            const nsParam = '&ns=';
            
            // Set episode download link
            downloadEpisodeBtn.href = `download.html?${showIdParam}${seasonParam}${episodeParam}${nsParam}`;
            
            // Set season download link
            downloadSeasonBtn.href = `download.html?${showIdParam}${seasonParam}${nsParam}`;
            
            // Set all seasons download link
            document.getElementById('downloadAllSeasonsBtn').href = `download.html?${showIdParam}${nsParam}`;
            // Set airdate and rating
            airdate.innerHTML = episodeData.air_date ? 
                `<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7v-5z"/>
                </svg> ${new Date(episodeData.air_date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })}` : 
                'TBA';
            
            if (episodeData.vote_average > 0) {
                rating.innerHTML = `
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="#fbbf24">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                    ${episodeData.vote_average.toFixed(1)}/10`;
                voteCount.textContent = `(${episodeData.vote_count.toLocaleString()} votes)`;
            } else {
                rating.innerHTML = `
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="#a0aec0">
                        <path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/>
                    </svg>
                    Not rated`;
                voteCount.textContent = '';
            }

            // Set overview or show message if none
            overview.textContent = episodeData.overview || 'No overview available for this episode.';

            // Load trailer and screenshots in parallel
            Promise.all([
                loadTrailer(showId, seasonNumber, episodeNumber, trailerContainer),
                loadEpisodeScreenshots(showId, seasonNumber, episodeNumber, screenshots)
            ]).catch(error => {
                console.error('Error loading content:', error);
            });

            // Set download link
            downloadLink.href = `download.html?show=${showId}&season=${seasonNumber}&episode=${episodeNumber}&ns=1`;
            downloadLink.innerHTML = `
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="margin-right: 6px;">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Download Episode`;
        }

        // Function to close the popup
        function closeEpisodePopup() {
            const popup = document.getElementById('episodePopup');
            const trailerContainer = document.getElementById('episodeTrailer');
            
            // Remove show class to trigger the fade out animation
            popup.classList.remove('show');
            
            // Wait for animation to complete before hiding
            setTimeout(() => {
                // Clean up the YouTube iframe if it exists
                while (trailerContainer.firstChild) {
                    trailerContainer.removeChild(trailerContainer.firstChild);
                }
                
                // Hide the popup
                popup.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Reset scroll position
                popup.scrollTop = 0;
                
                // Reset the content for next time
                const still = document.getElementById('episodeStill');
                const screenshots = document.getElementById('episodeScreenshots');
                still.innerHTML = '';
                screenshots.innerHTML = '<div class="loading">Loading screenshots...</div>';
            }, 300); // Match this with the CSS transition duration
        }

        // Function to load trailer
        async function loadTrailer(showId, seasonNumber, episodeNumber, container) {
            try {
                // First try to get episode videos
                const response = await fetch(`https://api.themoviedb.org/3/tv/${showId}/season/${seasonNumber}/episode/${episodeNumber}/videos?api_key=${API_KEY}`);
                const data = await response.json();
                
                let videoKey = null;
                
                // Look for a trailer
                const trailer = data.results.find(video => 
                    video.type === 'Trailer' && 
                    video.site === 'YouTube' &&
                    (video.name.toLowerCase().includes('trailer') || video.name.toLowerCase().includes('preview'))
                );
                
                // If no trailer found, try to find any YouTube video
                videoKey = trailer?.key || (data.results.find(v => v.site === 'YouTube')?.key);
                
                if (!videoKey) {
                    // If no episode video, try to get season videos
                    const seasonResponse = await fetch(`https://api.themoviedb.org/3/tv/${showId}/season/${seasonNumber}/videos?api_key=${API_KEY}`);
                    const seasonData = await seasonResponse.json();
                    
                    const seasonTrailer = seasonData.results.find(video => 
                        video.type === 'Trailer' && 
                        video.site === 'YouTube' &&
                        (video.name.toLowerCase().includes('trailer') || video.name.toLowerCase().includes('preview'))
                    );
                    
                    videoKey = seasonTrailer?.key || (seasonData.results.find(v => v.site === 'YouTube')?.key);
                }
                
                if (videoKey) {
                    const iframe = document.createElement('iframe');
                    iframe.width = '100%';
                    iframe.height = '100%';
                    // Force Full HD quality with high quality settings
                    iframe.src = `https://www.youtube.com/embed/${videoKey}?autoplay=0&rel=0&showinfo=0&vq=hd1080&hd=1&modestbranding=1&controls=1&showinfo=0&iv_load_policy=3&cc_load_policy=0&fs=1&autohide=2`;
                    iframe.frameBorder = '0';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    iframe.allowFullscreen = true;
                    
                    container.innerHTML = '';
                    container.appendChild(iframe);
                } else {
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #1a1a2e; color: #a0aec0;">No trailer available</div>';
                }
            } catch (error) {
                console.error('Error loading trailer:', error);
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #1a1a2e; color: #a0aec0;">Error loading trailer</div>';
            }
        }

        // Function to load episode screenshots
        async function loadEpisodeScreenshots(showId, seasonNumber, episodeNumber, container) {
            try {
                // First, try to get episode-specific images
                const response = await fetch(`https://api.themoviedb.org/3/tv/${showId}/season/${seasonNumber}/episode/${episodeNumber}/images?api_key=${API_KEY}`);
                const data = await response.json();
                
                // Get up to 4 screenshots for the grid
                const screenshots = data.stills ? data.stills.slice(0, 4) : [];
                
                if (screenshots.length > 0) {
                    container.innerHTML = `
                        <h3>Screenshots</h3>
                        <div class="screenshot-grid">
                            ${screenshots.map((screenshot, index) => `
                                <div class="screenshot-item" data-index="${index}">
                                    <img src="https://image.tmdb.org/t/p/w500${screenshot.file_path}" 
                                         data-original="https://image.tmdb.org/t/p/original${screenshot.file_path}"
                                         alt="Screenshot ${index + 1}" 
                                         loading="lazy"
                                         class="screenshot-img">
                                </div>
                            `).join('')}
                        </div>
                    `;
                    return screenshots.map(s => s.file_path);
                } else {
                    // Fallback to season images if no episode images found
                    const seasonResponse = await fetch(`https://api.themoviedb.org/3/tv/${showId}/season/${seasonNumber}/images?api_key=${API_KEY}`);
                    const seasonData = await seasonResponse.json();
                    
                    const seasonScreenshots = seasonData.posters ? seasonData.posters.slice(0, 4) : [];
                    
                    if (seasonScreenshots.length > 0) {
                        container.innerHTML = `
                            <h3>Season Screenshots</h3>
                            <div class="screenshot-grid">
                                ${seasonScreenshots.map((screenshot, index) => `
                                    <div class="screenshot-item" data-index="${index}">
                                        <img src="https://image.tmdb.org/t/p/w500${screenshot.file_path}" 
                                             data-original="https://image.tmdb.org/t/p/original${screenshot.file_path}"
                                             alt="Season Screenshot ${index + 1}" 
                                             loading="lazy"
                                             class="screenshot-img">
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        return seasonScreenshots.map(s => s.file_path);
                    } else {
                        container.innerHTML = '<p>No screenshots available for this episode.</p>';
                        return [];
                    }
                }
            } catch (error) {
                console.error('Error loading screenshots:', error);
                container.innerHTML = '<p>Error loading screenshots.</p>';
                return [];
            }
        } 

        // Close popup when clicking outside content or pressing Escape
        const popup = document.getElementById('episodePopup');
        const popupContent = document.querySelector('.popup-content');
        
        popup.addEventListener('click', function(e) {
            // Close if clicking directly on overlay or close button
            if (e.target === this || e.target.closest('.close-popup')) {
                closeEpisodePopup();
            }
        });
        
        // Stop event propagation when clicking inside the popup content
        if (popupContent) {
            popupContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEpisodePopup();
            }
        });
    </script>

    <!-- Episode Details Popup -->
    <div id="episodePopup" class="episode-popup">
        <div class="popup-overlay"></div>
        <div class="popup-content">
            <button class="close-popup" onclick="closeEpisodePopup()">
                <ion-icon name="close"></ion-icon>
            </button>
            <div class="popup-header">
                <h2 id="popupEpisodeTitle">Loading...</h2>
            </div>
            <div class="popup-body">
                <div class="media-container">
                    <div id="episodeTrailer" class="episode-trailer"></div>
                </div>
                <div class="episode-meta">
                    <div class="episode-meta-content">
                        <div class="meta-row">
                            <span id="episodeAirdate" class="airdate"></span>
                            <span id="episodeRating" class="rating"></span>
                            <span id="episodeVoteCount" class="vote-count"></span>
                        </div>
                        <p id="episodeOverview" class="overview"></p>
                        <div class="screenshots" id="episodeScreenshots">
                            <div class="loading">Loading screenshots...</div>
                        </div>
                    </div>
                    <a id="downloadLink" href="#" class="download-btn">
                        <ion-icon name="download-outline"></ion-icon>
                        Download Episode
                    </a>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Popup Styles */
        .episode-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .popup-content {
            position: relative;
            max-width: 900px;
            margin: 2rem auto;
            background: #1f1f1f;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        .episode-popup.show .popup-overlay {
            opacity: 1;
        }
        
        .episode-popup.show .popup-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .close-popup {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            color: white;
            padding: 0;
            transition: all 0.2s ease;
        }
        
        .close-popup:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .close-popup svg {
            width: 20px;
            height: 20px;
        }
        
        .popup-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .popup-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: white;
        }
        
        .popup-body {
            padding: 1.5rem 0;
        }
        
        .media-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
            padding: 0 2rem;
        }
        
        .episode-trailer {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .episode-trailer iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .episode-meta {
            color: #e2e8f0;
            padding: 0 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            min-height: 60vh;
        }
        
        .episode-meta-content {
            flex: 1;
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            margin-bottom: 1.2rem;
            font-size: 0.95rem;
            color: #a0aec0;
            flex-wrap: wrap;
        }
        
        .meta-row span {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .overview {
            line-height: 1.7;
            margin-bottom: 1.8rem;
            color: #d1d5db;
            font-size: 1.02rem;
        }
        
        .screenshots {
            margin: 1.5rem 0;
        }
        
        .screenshots h3 {
            font-size: 1.3rem;
            margin: 2rem 0 1rem;
            color: white;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .screenshot-item {
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 16/9;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #2a2a2a;
        }
        
        .screenshot-item:hover {
            opacity: 0.9;
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .screenshot-item:hover {
            transform: scale(1.03);
        }
        
        .screenshot-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .screenshot-item img {
            border-radius: 12px;
            transition: transform 0.2s ease;
        }
        
        .screenshot-item:hover img {
            transform: scale(1.03);
        }
        
        .download-buttons {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
            margin: 2rem 0 !important;
            width: 100% !important;
            background: white !important;
            padding: 1.5rem !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        .download-buttons .download-btn {
            width: 100% !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            padding: 1rem 1.25rem !important;
            border-radius: 8px !important;
            text-decoration: none !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            min-height: 64px !important;
            text-align: left !important;
            background: white !important;
            border: 1px solid #e2e8f0 !important;
            color: #1a202c !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }
        
        .download-buttons .download-btn ion-icon {
            font-size: 1.2rem;
            margin-right: 0.8rem;
            flex-shrink: 0;
        }
        
        .download-buttons .download-btn span {
            font-size: 0.95rem;
            line-height: 1.3;
            font-weight: 500;
        }
        
        .episode-download {
            border-left: 4px solid #4f46e5;
        }
        
        .season-download {
            border-left: 4px solid #10b981;
        }
        
        .all-seasons-download {
            border-left: 4px solid #f59e0b;
        }
        
        .download-btn:hover {
            background-color: #f8fafc;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            color: #a0aec0;
            font-style: italic;
        }
        
        /* Gallery Modal */
        .gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .gallery-modal.show {
            display: flex;
            opacity: 1;
        }
        
        .gallery-content {
            position: relative !important;
            max-width: 90% !important;
            max-height: 90% !important;
            width: auto !important;
            height: auto !important;
            background: transparent !important;
            pointer-events: auto !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .gallery-main-img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
            transition: opacity 0.3s ease;
            position: relative;
        }
        
        .gallery-nav {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 1002;
        }
        
        .gallery-nav button {
            background: rgba(0, 0, 0, 0.6) !important;
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            color: white !important;
            width: 44px !important;
            height: 60px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            pointer-events: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            font-size: 24px !important;
        }
        
        .gallery-nav button:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        /* Download button styles - !important used to override conflicting styles */
        .download-btn {
            display: flex !important;
            width: 100% !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            background-color: #00b7ff !important;
            color: #fff !important;
            border: none !important;
            border-radius: 6px !important;
            max-width: none !important;
            padding: 12px 20px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            text-decoration: none !important;
            margin: 20px 0 0 0 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            position: static !important;
            left: auto !important;
            right: auto !important;
            bottom: auto !important;
            transform: none !important;
            transform-origin: initial !important;
            z-index: 1 !important;
            box-sizing: border-box !important;
        }
        
        /* Rotate icon for larger screens */
        @media (min-width: 1200px) {
            .download-btn ion-icon {
                font-size: 20px !important;
                transform: rotate(1turn) !important;
                transition: transform 0.2s ease !important;
            }
        }
        
        .download-btn:hover {
            background-color: #0095d9;
            transform: translateY(-2px);
        }
        
        .download-btn ion-icon {
            font-size: 18px;
        }
        
        .gallery-nav button ion-icon {
            font-size: 24px;
        }
        
        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6) !important;
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            color: white !important;
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            font-size: 1.5rem !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            z-index: 1003 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .gallery-close:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .gallery-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1002;
        }
        
        @media (max-width: 768px) {
            .popup-content {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .media-container {
                grid-template-columns: 1fr;
            }
            
            .popup-header, .popup-body {
                padding: 1.25rem;
            }
        }
    </style>

    <!-- Gallery Modal -->
    <div id="galleryModal" class="gallery-modal">
        <div class="gallery-content">
            <button class="gallery-close" onclick="closeGallery()" aria-label="Close gallery">
                <ion-icon name="close"></ion-icon>
            </button>
            <img id="galleryImage" src="" alt="Gallery Image" class="gallery-main-img">
            <div class="gallery-nav">
                <button onclick="prevImage()" aria-label="Previous image" class="gallery-nav-btn">
                    <ion-icon name="chevron-back-outline"></ion-icon>
                </button>
                <button onclick="nextImage()" aria-label="Next image" class="gallery-nav-btn">
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
            </div>
            <div class="gallery-counter" id="galleryCounter">1 / 1</div>
        </div>
    </div>

    <script>
        // Gallery functionality
        let currentGalleryImages = [];
        let currentGalleryIndex = 0;
        let clickHandler = null;

        function openGallery(images, startIndex = 0) {
            if (!images || !images.length) return;
            
            // Close any existing gallery first
            closeGallery();
            
            currentGalleryImages = images;
            currentGalleryIndex = startIndex;
            
            const modal = document.getElementById('galleryModal');
            const modalContent = document.querySelector('.gallery-content');
            const img = document.getElementById('galleryImage');
            const counter = document.getElementById('galleryCounter');
            
            // Load the first image
            img.src = getHighQualityImageUrl(images[startIndex]);
            counter.textContent = `${startIndex + 1} / ${images.length}`;
            
            // Show the modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleGalleryKeyDown);
            
            // Create a single handler for the entire modal
            clickHandler = function(e) {
                // Check if click is outside the content area
                if (!modalContent.contains(e.target)) {
                    closeGallery();
                }
            };
            
            // Add the click handler to the modal
            modal.addEventListener('click', clickHandler);
        }
        
        function closeGallery() {
            const modal = document.getElementById('galleryModal');
            if (!modal) return;
            
            // Remove the click handler
            if (clickHandler) {
                modal.removeEventListener('click', clickHandler);
                clickHandler = null;
            }
            
            // Hide the modal
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            document.removeEventListener('keydown', handleGalleryKeyDown);
            
            // Clear the image to prevent showing the previous image briefly when reopening
            const img = document.getElementById('galleryImage');
            if (img) img.src = '';
            
            // Reset the gallery state
            currentGalleryImages = [];
            currentGalleryIndex = 0;
        }
        
        function nextImage() {
            if (currentGalleryImages.length === 0) return;
            currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length;
            updateGalleryImage();
        }
        
        function prevImage() {
            if (currentGalleryImages.length === 0) return;
            currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
            updateGalleryImage();
        }
        
        function updateGalleryImage() {
            const img = document.getElementById('galleryImage');
            const counter = document.getElementById('galleryCounter');
            
            img.style.opacity = '0';
            
            // Load the new image
            const newImg = new Image();
            newImg.onload = function() {
                img.src = this.src;
                img.style.opacity = '1';
                counter.textContent = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
            };
            newImg.src = getHighQualityImageUrl(currentGalleryImages[currentGalleryIndex]);
        }
        
        function handleGalleryKeyDown(e) {
            switch(e.key) {
                case 'ArrowLeft':
                    prevImage();
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    nextImage();
                    e.preventDefault();
                    break;
                case 'Escape':
                    closeGallery();
                    e.preventDefault();
                    break;
            }
        }
        
        // Helper function to get higher quality image URL
        function getHighQualityImageUrl(path) {
            if (!path) return '';
            // Use original quality if available, otherwise use the best available
            return `https://image.tmdb.org/t/p/original${path}`;
        }
        
        // Update the loadEpisodeScreenshots function to use the gallery
        const originalLoadEpisodeScreenshots = loadEpisodeScreenshots;
        loadEpisodeScreenshots = function(showId, seasonNumber, episodeNumber, container) {
            return originalLoadEpisodeScreenshots(showId, seasonNumber, episodeNumber, container)
                .then(images => {
                    // Add click handlers to the screenshots
                    const screenshotItems = container.querySelectorAll('.screenshot-item');
                    screenshotItems.forEach((item, index) => {
                        item.addEventListener('click', () => {
                            openGallery(images, index);
                        });
                    });
                    return images;
                });
        };
    </script>
</body>
</html>